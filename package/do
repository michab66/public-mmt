#!/usr/bin/env bash

set -u
set -ex

PROJECT_HOME=..

## help : Print jpackage help.
function task_help {
    $BIN/jpackage --help
}

## installer_info : Set environment for the installer tasks.
function task_installer_info {
    echo "Installer info ..."
L_BN=`cat ../mmt_app/package/build.number`
L_POM_PATH=../pom.xml
APP_INFO_NAME=`xmllint $L_POM_PATH --xpath '/*[local-name()="project"]/*[local-name()="name"]/text()'`
echo APP_INFO_NAME $APP_INFO_NAME
APP_INFO_VERSION=`xmllint $L_POM_PATH --xpath '/*[local-name()="project"]/*[local-name()="version"]/text()'`.$L_BN
echo APP_INFO_VERSION $APP_INFO_VERSION
APP_INFO_VENDOR=`xmllint $L_POM_PATH --xpath '/*[local-name()="project"]/*[local-name()="properties"]/*[local-name()="vendor"]/text()'`
echo APP_INFO_VENDOR $APP_INFO_VENDOR
APP_INFO_ID=`xmllint $L_POM_PATH --xpath '/*[local-name()="project"]/*[local-name()="artifactId"]/text()'`
echo APP_INFO_ID $APP_INFO_ID
APP_INFO_MODULE=`xmllint $L_POM_PATH --xpath '/*[local-name()="project"]/*[local-name()="properties"]/*[local-name()="module"]/text()'`
echo APP_INFO_MODULE $APP_INFO_MODULE
}

## build : Build the image using Maven
function task_build {
    echo "build ..."

    pushd $PROJECT_HOME
    mvn clean install
    popd

    task_installer_info
}

# Comments
#
## jlink : Create the product image using jlink
function task_jlink {
    task_build

    pushd $PROJECT_HOME

JLINK_LIBS=target/jlinkLib
JLINK_RESULT=target/jlinkResult

mkdir $JLINK_LIBS

echo "Copying ..."
cp target/lib/* $JLINK_LIBS
sleep 1
cp target/modules/* $JLINK_LIBS
sleep 1
cp target/mmt-app-2.11.jar $JLINK_LIBS

echo "Link ..."

jlink \
--module-path \
  $JLINK_LIBS \
--no-header-files \
--no-man-pages \
--add-modules \
javafx.base,\
javafx.fxml,\
javafx.controls,\
javafx.graphics,\
javafx.swing,\
org.apache.pdfbox,\
org.apache.pdfbox.io,\
org.apache.fontbox,\
framework.smack,\
framework.smack_jfx,\
commons.logging,\
jdk.localedata,\
app.mmt \
--output \
$JLINK_RESULT \
--include-locales=en,de \
--add-options " --add-modules=app.mmt"

    popd
}

## jpackage : Create the product installer using jpackage
function task_jpackage {
    task_jlink

    task_installer_info

    echo "jpackage ..."

    pushd $PROJECT_HOME

INSTALLER=target/packageInstaller
rm -rf $INSTALLER

jpackage \
--name "$APP_INFO_NAME" \
--vendor "$APP_INFO_VENDOR" \
--app-version "$APP_INFO_VERSION" \
--module $APP_INFO_MODULE \
--runtime-image $JLINK_RESULT \
--dest $INSTALLER

echo "Created installer @ $INSTALLER"
ls -la $INSTALLER
    popd
}

## generate : Generate image.
function task_generate {

    BUILD_DIR=../../target/package-installers/$PLATFORM
    if [ -d "$BUILD_DIR"  ]; then
        rm -rf "$BUILD_DIR"
    fi
    mkdir -p "$BUILD_DIR"

    if [ ! -e "$JPACKAGE_OPTS_FILE" ]; then
        echo "$JPACKAGE_OPTS_FILE" expected in `pwd`
        exit 1
    fi

    # Increment build number.
    bc <<< "`cat ../build.number`+1" > ../build.number

    ./"$JPACKAGE_OPTS_FILE" > "$BUILD_DIR/jpackage.opts"

    $BIN/jpackage --dest "$BUILD_DIR" "@$BUILD_DIR/jpackage.opts"
}

## generatex : Generate image.
function task_generatex {
    if [ -z $1 ]; then
        echo Parameter workdir is missing.
        exit 1
    fi

    pushd $1
    task_generate
    popd
}

function task_usage {
  echo "Usage: $0"
  sed -n 's/^##//p' <$0 | column -t -s ':' |  sed -E $'s/^/\t/'
}

CMD=${1:-}
shift || true
RESOLVED_COMMAND=$(echo "task_"$CMD | sed 's/-/_/g')
if [ "$(LC_ALL=C type -t $RESOLVED_COMMAND)" == "function" ]; then
  $RESOLVED_COMMAND "$@"
else
  task_usage
fi

